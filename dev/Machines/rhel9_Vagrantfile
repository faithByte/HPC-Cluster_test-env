Vagrant.configure("2") do |config|
	config.vm.box_version = "4.3.12"
	config.vm.provider "virtualbox" do |vb|
		vb.memory = "2048"
		vb.cpus = 2
	end

	config.vm.synced_folder "../../", "/vagrant"
	config.vbguest.auto_update = false

	config.vm.provision "shell", inline: <<-SHELL
		dnf update -y
		dnf install -y vim sshpass

		# ssh config
		sed -i.bak 's/^PasswordAuthentication no/PasswordAuthentication yes/' "/etc/ssh/sshd_config"
		sed -i.bak 's/^#PubkeyAuthentication yes/PubkeyAuthentication yes/' "/etc/ssh/sshd_config"
		ssh-keygen -t rsa -b 4096 -f "$HOME/.ssh/id_rsa" -N "" 
		systemctl reload sshd

		echo "root: " | chpasswd
		
		echo 'cd /vagrant/dev' >> /root/.bashrc
		echo 'export DIR=RedHat' >> /root/.bashrc
	SHELL

	config.vm.define "node" do |node|
		node.vm.box = "generic/rocky9"
		node.vm.provider "virtualbox" do |vb|
			vb.name = "Rocky Mirror Client"
		end
		node.vm.synced_folder "../../", "/vagrant"
		node.vm.hostname = "node"
	end

	config.vm.define "master" do |master|
		master.vm.box = "generic/rhel9"
		master.vm.hostname = "master"
		master.vm.provider "virtualbox" do |vb|
			vb.name = "RedHat Mirror Server"
		end
		master.vm.network "private_network", ip: "192.168.56.10"
	

		master.vm.provision "shell", inline: <<-SHELL
			# register rhel
			source /vagrant/dev/RedHat/passwords.sh
			subscription-manager remove --all
			subscription-manager unregister
			subscription-manager clean
			dnf clean all
			rm -rf /var/cache/yum/*
			subscription-manager register --username $RH_USER --password $RH_PASS --auto-attach

			# ansible config
			dnf install -y ansible
			echo [defaults] > ~/.ansible.cfg
			echo "host_key_checking = False" >> ~/.ansible.cfg

		SHELL
	end

end